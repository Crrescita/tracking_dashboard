<div class="">
  <h5>Salary details</h5>
  <p class="text-muted">Fill all information below</p>

  <!-- Nav tabs -->
  <tabset [justified]="true" class="mb-3 d-flex gap-3 flex-column nav-badge">
    <tab>
      <ng-template tabHeading>
        <a
          class="nav-link"
          data-bs-toggle="tab"
          href="javascript:void(0);"
          role="tab"
          aria-selected="false"
        >
          Salary Details
        </a>
      </ng-template>
      <div class="tab-pane" id="nav-badge-home" role="tabpanel">
        <form [formGroup]="formGroup" (ngSubmit)="onSubmit()">
          <div class="row g-3">
            <div class="col-6 ms-4">
              <label for="salary_id" class="form-label"
                >Net Salary <span class="text-danger">*</span></label
              >
              <input
                type="number"
                formControlName="salary"
                class="form-control"
                id="salary_id"
                placeholder=""
              />
              @if (f['salary'] && f['salary'].hasError('required') &&
              f['salary'].touched) {
              <div class="invalid-text">Salary is required.</div>
              } @if(f['salary'] && f['salary'].hasError('minlength') &&
              f['salary'].touched){
              <div class="invalid-text">Salary must be at least 0.</div>
              }
            </div>

            <!-- <div class="col-6 ms-4">
              <label for="basic_salary_id" class="form-label"
                >Basic Salary <span class="text-danger">*</span></label
              >
              <input
                type="number"
                formControlName="basic_salary"
                class="form-control"
                id="basic_salary_id"
                placeholder=""
              />

              @if (f['basic_salary'] && f['basic_salary'].hasError('required')
              && f['basic_salary'].touched) {
              <div class="invalid-text">Basic Salary is required.</div>
              } @if(f['basic_salary'] && f['basic_salary'].hasError('minlength')
              && f['basic_salary'].touched){
              <div class="invalid-text">Salary must be at least 0.</div>
              }

              <div
                *ngIf="
                                                      formGroup.errors?.['basicSalaryGreaterThanSalary'] && formGroup.touched
                                                    "
                class="invalid-text"
              >
                Basic Salary cannot be greater than Salary.
              </div>
            </div> -->

            <div class="col-6 ms-3 mt-3">
              <div class="hstack gap-2 justify-content-end mb-3">
                @if (saveButtonActive) {
                <button class="btn btn-primary">Save</button>
                } @else {
                <button class="btn btn-secondary" type="button" disabled>
                  <span
                    class="spinner-border spinner-border-sm"
                    role="status"
                    aria-hidden="true"
                  ></span>
                  Please wait
                </button>
                }
              </div>
            </div>

            <div class="table-responsive mt-4">
              <table
                class="invoice-table table table-borderless table-nowrap mb-0"
              >
                <thead class="align-middle">
                  <tr class="table-light">
                    <th scope="col" style="width: 50px">#</th>
                    <th scope="col">Earning</th>

                    <th scope="col">Calculation</th>
                    <th scope="col" class="text-end" style="width: 150px">
                      Amount
                    </th>
                    <th scope="col" class="text-end" style="width: 105px"></th>
                  </tr>
                </thead>
                <tbody id="newlink" formArrayName="breakup">
                  @for (data of breakup.controls; track $index) {
                  <tr id="1" class="product-elem" [formGroupName]="$index">
                    <th scope="row" class="product-id">
                      {{ $index + 1 }} <span>{{ "A" + ($index + 1) }}</span>
                    </th>
                    <td class="text-start">
                      <div class="mb-2">
                        <input
                          type="text"
                          class="form-control w-50"
                          id="name-{{ $index + 1 }}"
                          formControlName="name"
                          placeholder="Enter name"
                          [readonly]="
                            data.get('nameReadonly')?.value || $index === 0
                          "
                        />

                        <div
                          *ngIf="
                            data.get('name')?.invalid &&
                            data.get('name')?.touched
                          "
                        >
                          <small class="invalid-text">
                            Please enter a name.</small
                          >
                        </div>
                      </div>
                      <!-- <textarea
                        class="form-control"
                        id="productDetails-1"
                        rows="2"
                        placeholder="Product Details"
                      ></textarea> -->
                    </td>

                    <td class="text-end">
                      <div>
                        <!-- Select Calculation Type -->
                        <select
                          class="form-select w-50"
                          formControlName="calculationType"
                          (change)="
                            onCalculationTypeChange($event, $index, data)
                          "
                        >
                          <ng-container
                            *ngIf="
                              data.get('formula')?.value;
                              else customOptions
                            "
                          >
                            <!-- Show 'Default' option if formula exists -->
                            <option value="default" selected>Default</option>
                            <option value="custom">Custom</option>
                            <option value="formula">Formula Builder</option>
                          </ng-container>
                          <ng-template #customOptions>
                            <!-- Regular options -->
                            <option value="custom">Custom</option>
                            <option value="formula">Formula Builder</option>
                          </ng-template>
                        </select>

                        <!-- Custom Amount Input -->
                        <!-- <input
                          *ngIf="
                            data.get('calculationType')?.value === 'custom'
                          "
                          class="form-control invoice-product-line-price"
                          type="number"
                          id="amount-{{ $index }}"
                          formControlName="amount"
                          placeholder="Enter amount"
                        /> -->

                        <!-- Formula Builder Input -->
                        <div
                          *ngIf="
                            data.get('calculationType')?.value === 'formula'
                          "
                        >
                          <!-- Formula Input -->
                          <!-- (input)="onFormulaInput($event, $index)" -->
                          <input
                            type="text"
                            class="form-control"
                            formControlName="formula"
                            placeholder="Enter formula (e.g., netSalary + totalAmount)"
                          />
                          <small class="text-muted">
                            Use valid expressions for calculation.
                          </small>

                          <!-- Formula Builder: Predefined variables list -->
                          <div class="mt-2">
                            <label for="variables">Choose Variables:</label>
                            <div>
                              <a
                                *ngFor="let variable of availableVariables"
                                class="btn btn-outline-secondary btn-sm"
                                (click)="insertVariable(variable, $index)"
                              >
                                {{ variable.name }}: {{ variable.value }}
                              </a>
                            </div>
                          </div>

                          <!-- Formula Operations -->
                          <div class="mt-2">
                            <label for="operations">Choose Operations:</label>
                            <div>
                              <a
                                *ngFor="let operation of operations"
                                class="btn btn-outline-secondary btn-sm"
                                (click)="insertOperation(operation, $index)"
                              >
                                {{ operation }}
                              </a>
                            </div>
                          </div>

                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm mt-2"
                            (click)="evaluateFormula($index)"
                          >
                            Evaluate
                          </button>
                        </div>

                        <!-- Error Messages -->
                        <!-- <div
                          *ngIf="
                            data.get('amount')?.invalid &&
                            data.get('amount')?.touched &&
                            data.get('calculationType')?.value === 'custom'
                          "
                        >
                          <small class="invalid-text"
                            >Amount is required and must be positive.</small
                          >
                        </div> -->
                        <div
                          *ngIf="
                            data.get('formula')?.invalid &&
                            data.get('formula')?.touched &&
                            data.get('calculationType')?.value === 'formula'
                          "
                        >
                          <small class="invalid-text"
                            >Formula is required.</small
                          >
                        </div>
                      </div>
                    </td>

                    <td class="text-end">
                      <div>
                        <input
                          class="form-control invoice-product-line-price"
                          type="number"
                          id="amount-{{ $index }}"
                          formControlName="amount"
                          thousandSeparator=","
                          decimalMarker="."
                          placeholder="Enter amount"
                          (input)="
                            validateTotal(); onFormulaInput($event, $index)
                          "
                          [readonly]="
                            data.get('calculationType')?.value === 'formula' ||
                            data.get('calculationType')?.value === 'default'
                          "
                        />

                        <!-- (input)="onFormulaInput($event, $index)" -->
                        <div
                          *ngIf="
                            data.get('amount')?.invalid &&
                            data.get('amount')?.touched
                          "
                        >
                          <small class="invalid-text"
                            >Amount is required and must be positive.</small
                          >
                        </div>
                      </div>
                    </td>
                    <td class="product-removal">
                      @if($index != 0){
                      <a
                        href="javascript:void(0)"
                        class="btn btn-danger"
                        (click)="removeRow($index)"
                        >Delete</a
                      >
                      }
                    </td>
                  </tr>
                  }
                </tbody>
                <tbody>
                  <tr id="newForm" style="display: none">
                    <td class="d-none" colspan="5">
                      <p>Add New Form</p>
                    </td>
                  </tr>
                  <tr>
                    <!-- (click)="addRow()" btn btn-subtle-secondary -->
                    <td colspan="5">
                      <a
                        href="javascript:void(0)"
                        id="add-item"
                        class="fw-medium"
                        (click)="openAllowance(allowanceSelect)"
                        ><i class="ri-add-fill me-1 align-bottom"></i> Add
                        Allowance</a
                      >
                      <div
                        class="col-2"
                        [ngClass]="showAllowanceSelect ? 'd-block' : 'd-none'"
                      >
                        <ng-container>
                          <ng-select
                            #allowanceSelect
                            [items]="allowances"
                            (change)="onSelectionChange($event)"
                            bindLabel="name"
                            placeholder="Select Allowance"
                          >
                            <ng-template ng-footer-tmp>
                              <a
                                class="btn btn-sm btn-primary w-100"
                                (click)="addRow(null)"
                              >
                                Add Custom
                              </a>
                            </ng-template>
                          </ng-select>
                        </ng-container>
                      </div>
                    </td>
                    <!--  -->
                  </tr>
                  <tr class="border-top border-top-dashed mt-2">
                    <td colspan="3"></td>
                    <td colspan="2" class="p-0">
                      <table
                        class="table table-borderless table-sm table-nowrap align-middle mb-0"
                      >
                        <tbody>
                          <!-- <tr>
                            <th scope="row">Sub Total</th>
                            <td style="width: 150px">
                              <input
                                type="text"
                                class="form-control"
                                id="cart-subtotal"
                                mask="separator.2"
                                thousandSeparator=","
                                decimalMarker="."
                                formControlName="subtotal"
                                placeholder="$0.00"
                              />
                            </td>
                          </tr>
                          <tr>
                            <th scope="row">Estimated Tax (18%)</th>
                            <td>
                              <input
                                type="text"
                                class="form-control"
                                id="cart-tax"
                                formControlName="tax"
                                mask="separator.2"
                                thousandSeparator=","
                                decimalMarker="."
                                placeholder="$0.00"
                                readonly
                              />
                            </td>
                          </tr>
                          <tr>
                            <th scope="row">
                              Discount
                              <small class="text-muted">(STEEX30)</small>
                            </th>
                            <td>
                              <input
                                type="text"
                                class="form-control"
                                id="cart-discount"
                                formControlName="discount"
                                mask="separator.2"
                                thousandSeparator=","
                                decimalMarker="."
                                placeholder="$0.00"
                                readonly
                              />
                            </td>
                          </tr>
                          <tr>
                            <th scope="row">Shipping Charge</th>
                            <td>
                              <input
                                type="text"
                                class="form-control"
                                id="cart-shipping"
                                formControlName="charge"
                                mask="separator.2"
                                thousandSeparator=","
                                decimalMarker="."
                                placeholder="$0.00"
                                readonly
                              />
                            </td>
                          </tr> -->
                          <tr class="border-top border-top-dashed">
                            <th scope="row">Total Amount</th>
                            <td>
                              <!-- formControlName="total" -->
                              <input
                                type="text"
                                class="form-control"
                                id="cart-total"
                                mask="separator.2"
                                thousandSeparator=","
                                decimalMarker="."
                                placeholder="$0.00"
                                readonly
                                value="{{ totalAmount }}"
                              />
                            </td>
                          </tr>
                          <div *ngIf="totalError" class="text-danger">
                            Total must equal Net Salary.
                          </div>
                        </tbody>
                      </table>
                      <!--end table-->
                    </td>
                  </tr>
                </tbody>
              </table>
              <!--end table-->
            </div>
          </div>
        </form>
      </div>
    </tab>
    <tab>
      <ng-template tabHeading>
        <a
          class="nav-link align-middle"
          data-bs-toggle="tab"
          href="javascript:void(0);"
          role="tab"
          aria-selected="false"
        >
          Salary Invoice
        </a>
      </ng-template>
      <div class="tab-pane" id="nav-badge-profile" role="tabpanel">
        <div class="row justify-content-center"></div>
      </div>
    </tab>
  </tabset>
  <!-- Nav tabs -->
</div>
